<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>Toto.api.routes API documentation</title>
<meta name="description" content="Handles all the routes related to the api" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>Toto.api.routes</code></h1>
</header>
<section id="section-intro">
<p>Handles all the routes related to the api</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;
Handles all the routes related to the api
&#34;&#34;&#34;
import os
import hashlib
import random
from datetime import datetime

from flask import Blueprint, Response, jsonify, request, redirect, url_for, session, flash
from pymongo.errors import DuplicateKeyError, OperationFailure, CollectionInvalid

import Toto.database.DAO.DAOCounter as DAOCounter
import Toto.database.DAO.DAOUser as DAOUser
import Toto.database.DAO.DAOBoard as DAOBoard
import Toto.database.DAO.DAOPosts as DAOPosts
import Toto.database.db as db
from Toto.models.post import Post
from Toto.models.user import User
from Toto.utils.logs import logger
import Toto.utils.globals as g

#Get boards
bp_get_boards = Blueprint(&#34;get_boards&#34;, __name__, url_prefix=&#34;/api&#34;)

@bp_get_boards.route(&#34;/get_boards&#34;, methods = [&#39;GET&#39;])
def get_boards():
    &#34;&#34;&#34;
    Returns a json with all the boards.
    &#34;&#34;&#34;
    return jsonify(DAOBoard.getAllBoards())

#Get posts
bp_get_posts = Blueprint(&#34;get_posts&#34;, __name__, url_prefix=&#34;/api&#34;)

@bp_get_posts.route(&#34;/get_posts&#34;, methods = [&#39;GET&#39;])
def get_posts():
    &#34;&#34;&#34;
    Returns a json with all the posts from a board.
    Required url args: &#39;board&#39; (name of the collection).
    &#34;&#34;&#34;
    board = request.args.get(&#39;board&#39;)
    if DAOBoard.checkIfBoardExists(board):
        return jsonify(DAOPosts.getAllPostsFromBoard(board))
    else:
        return Response(&#34;Board {0} not found&#34;.format(board), status=404)

#Create post
bp_create_post = Blueprint(&#34;create_post&#34;, __name__, url_prefix=&#34;/api&#34;)

@bp_create_post.route(&#34;/create_post&#34;, methods = [&#39;POST&#39;])
def create_post():
    &#34;&#34;&#34;
    Creates a post in the desired board.
    Required url args: &#39;board&#39; (name of the collection).
    Required html form parameters: username, title, content and a file named &#39;media&#39;.
    &#34;&#34;&#34;
    board = request.args.get(&#39;board&#39;)
    if DAOBoard.checkIfBoardExists(board):
        board = DAOBoard.getBoardByCollectionName(board)
        collection = db.mongo[g.DATABASE_NAME][board.collection_name]
        data = request.form
        media = request.files[&#34;media&#34;]
        media_fileformat = media.filename.split(&#34;.&#34;)[-1]
        generated_filename = None
        path = None
        if media:
            generated_filename = &#34;{0}.{1}&#34;.format(str(random.randint(10_000_000, 99_999_999)), media_fileformat)
            if media_fileformat in g.ALLOWED_IMAGE_EXTENSIONS:
                path = os.path.normpath(os.path.join(os.path.dirname(__file__), &#34;../site/templates/static/images/&#34;, generated_filename))
            elif media_fileformat in g.ALLOWED_VIDEO_EXTENSIONS:
                path = os.path.join(os.path.normpath(os.path.join(os.path.dirname(__file__), &#34;../site/templates/static/videos/&#34;, generated_filename)))
            else:
                return Response(&#34;Invalid file format&#34;, status=415)
            media.save(path)
        post = Post(DAOCounter.getBoardSequence(board.collection_name), False, data[&#34;title&#34;], data[&#34;username&#34;], datetime.now(), generated_filename, data[&#34;content&#34;], [])
        collection.insert_one(post.to_dict())
        logger.info(&#34;New post created on {0} with id {1} by {2}&#34;.format(board.collection_name, post.id, post.username))
        DAOPosts.deleteLastPostIfOverLimit(board.collection_name)
        return redirect(&#34;/{0}/&#34;.format(board.abbreviation))
    else:
        return Response(&#34;Board {0} not found&#34;.format(board.collection_name), status=404)

#Delete post
bp_delete_post = Blueprint(&#34;delete_post&#34;, __name__, url_prefix=&#34;/api&#34;)

@bp_delete_post.route(&#34;/delete_post&#34;, methods = [&#39;GET&#39;])
def delete_post():
    &#34;&#34;&#34;
    Deletes a post by it&#39;s id from the specified board.
    Required url args: &#39;board&#39; (name of the collection), &#39;post_id&#39;.
    WARNING: Requires admin permissions.
    &#34;&#34;&#34;
    board = request.args.get(&#34;board&#34;)
    board = DAOBoard.getBoardByCollectionName(board)
    post_id = request.args.get(&#34;post_id&#34;)
    if session[&#39;is_admin&#39;]:
        if DAOBoard.checkIfBoardExists(board.collection_name):
            if DAOPosts.deletePostById(post_id, board.collection_name):
                logger.info(&#34;Deleted post with id {0} in {1}&#34;.format(post_id, board.collection_name))
                return redirect(&#34;/{0}/&#34;.format(board.abbreviation))
            else:
                return Response(&#34;Couldn&#39;t delete the post {0}&#34;.format(post_id), status=404)
        else:
            return Response(&#34;Board {0} not found&#34;.format(board.collection_name), status=404)
    else:
        return Response(&#34;You don&#39;t enough permissions to delete posts&#34;, status=403)

#Create comment
bp_create_comment = Blueprint(&#34;create_comment&#34;, __name__, url_prefix=&#34;/api&#34;)

@bp_create_comment.route(&#34;/create_comment&#34;, methods = [&#39;POST&#39;])
def create_comment():
    &#34;&#34;&#34;
    Creates a comment under the the desired post.
    Required url args: &#39;board&#39; (name of the collection).
    Required html form parameters: id (this is the id of the post we want to comment under), response_to, username, content and a file named &#39;media&#39;.
    &#34;&#34;&#34;
    board = request.args.get(&#34;board&#34;)
    data = request.form
    media = request.files[&#34;media&#34;]
    media_fileformat = media.filename.split(&#34;.&#34;)[-1]
    path = None
    generated_filename = None
    if media:
        generated_filename = &#34;{0}.{1}&#34;.format(str(random.randint(10_000_000, 99_999_999)), media_fileformat)
        if media_fileformat in g.ALLOWED_IMAGE_EXTENSIONS:
            path = os.path.normpath(os.path.join(os.path.dirname(__file__), &#34;../site/templates/static/images/&#34;, generated_filename))
        elif media_fileformat in g.ALLOWED_VIDEO_EXTENSIONS:
            path = os.path.normpath(os.path.join(os.path.dirname(__file__), &#34;../site/templates/static/videos/&#34;, generated_filename))
        else:
            return Response(&#34;Invalid file format&#34;, status=415)
        media.save(path)
    post = DAOPosts.getPostByIdOrCommentId(data[&#34;id&#34;], board)
    if post:
        comment = {&#34;_id&#34;: DAOCounter.getBoardSequence(board), &#34;response_to&#34;: data[&#34;response_to&#34;], &#34;username&#34;: data[&#34;username&#34;], &#34;filename&#34;: generated_filename, &#34;date&#34;: datetime.now(), &#34;content&#34;: data[&#34;content&#34;]}
        collection = db.mongo[g.DATABASE_NAME][board]
        collection.update_one({&#34;_id&#34;: post.id}, {&#34;$push&#34;: {&#34;comments&#34;: comment}})
        logger.info(&#34;New comment with id {0} created on {1} by {2}&#34;.format(comment[&#34;_id&#34;], board, comment[&#34;username&#34;]))
        return redirect(&#34;/{0}/{1}&#34;.format(DAOBoard.getBoardByCollectionName(board).abbreviation, post.id))
    else:
        return Response(&#34;There is no post that has or contains this id&#34;, status=404)

#Delete comment
bp_delete_comment = Blueprint(&#34;delete_comment&#34;, __name__, url_prefix=&#34;/api&#34;)

@bp_delete_comment.route(&#34;/delete_comment&#34;, methods = [&#39;GET&#39;])
def delete_comment():
    &#34;&#34;&#34;
    Deletes a comment by it&#39;s id and the parent&#39;s post id
    Required url args: &#39;board&#39; (name of the collection), &#39;comment_id&#39;, &#39;post_id&#39;.
    WARNING: Requires admin permissions.
    &#34;&#34;&#34;
    board = request.args.get(&#34;board&#34;)
    board = DAOBoard.getBoardByCollectionName(board)
    post_id = request.args.get(&#34;post_id&#34;)
    comment_id = request.args.get(&#34;comment_id&#34;)
    if session[&#39;is_admin&#39;]:
        if DAOBoard.checkIfBoardExists(board.collection_name):
            if DAOPosts.deleteCommentById(comment_id, post_id, board.collection_name):
                logger.info(&#34;Deleted comment with id {0} on post {1} in {2}&#34;.format(comment_id, post_id, board.collection_name))
                return redirect(&#34;/{0}/{1}&#34;.format(board.abbreviation, post_id))
            else:
                return Response(&#34;Couldn&#39;t delete the comment {0}&#34;.format(post_id), status=404)
        else:
            return Response(&#34;Board {0} not found&#34;.format(board.collection_name), status=404)
    else:
        return Response(&#34;You don&#39;t enough permissions to delete comments&#34;, status=403)

#Create board
bp_create_board = Blueprint(&#34;create_board&#34;, __name__, url_prefix=&#34;/api&#34;)

@bp_create_board.route(&#34;/create_board&#34;, methods = [&#39;POST&#39;])
def create_board():
    &#34;&#34;&#34;
    Creates a new board.
    Required html form parameters: board_name, abbreviation.
    WARNING: Requires admin permissions.
    &#34;&#34;&#34;
    if session[&#39;is_admin&#39;]:
        data = request.form
        try:
            db.mongo[g.DATABASE_NAME].create_collection(name=&#34;Board_{0}&#34;.format(data[&#34;board_name&#34;].capitalize()), check_exists=True)
            collection_boards = db.mongo[g.DATABASE_NAME][&#34;Boards&#34;]
            board_data = {&#34;collection_name&#34;: &#34;Board_{0}&#34;.format(data[&#34;board_name&#34;].capitalize()), &#34;name&#34;: data[&#34;board_name&#34;].capitalize(), &#34;abbreviation&#34;: data[&#34;abbreviation&#34;].lower()}
            collection_boards.insert_one(board_data)
            collection_counters = db.mongo[g.DATABASE_NAME][&#34;Counters&#34;]
            counter_data = {&#34;collection&#34;: &#34;Board_{0}&#34;.format(data[&#34;board_name&#34;].capitalize()), &#34;sequence&#34;: 0}
            collection_counters.insert_one(counter_data)
            return redirect(&#34;/{0}/&#34;.format(board_data[&#34;abbreviation&#34;]))
        except CollectionInvalid:
            return Response(&#34;A board with this name already exists&#34;, status=409)
    else:
        return Response(&#34;You don&#39;t have permissions to delete create boards&#34;, status=403)

#Create user
bp_create_user = Blueprint(&#34;create_user&#34;, __name__, url_prefix=&#34;/api&#34;)

@bp_create_user.route(&#34;/create_user&#34;, methods = [&#39;POST&#39;])
def create_user():
    &#34;&#34;&#34;
    Creates a new user.
    Required html form parameters: username, email, password.
    &#34;&#34;&#34;
    collection = db.mongo[g.DATABASE_NAME][&#34;Users&#34;]
    if len(request.form[&#34;password&#34;]) &lt; 8:
        return Response(&#34;Invalid password length, the password must be at least 8 characters long&#34;, status=400)
    try:
        salt = os.urandom(16)
        user = User(request.form[&#34;username&#34;], request.form[&#34;email&#34;], hashlib.sha256(request.form[&#34;password&#34;].encode(&#34;utf-8&#34;) + salt).digest(), salt, False, datetime.now())
        collection.insert_one(user.to_dict())
        logger.info(&#34;New user {0} created&#34;.format(user.username))
        flash(&#34;User created successfully&#34;)
        return redirect(&#34;/user/login&#34;)
    except DuplicateKeyError:
        return Response(&#34;Username {0} already exists&#34;.format(user.username), status=400)

#Login
bp_api_login = Blueprint(&#34;api_login&#34;, __name__, url_prefix=&#34;/api&#34;)

@bp_api_login.route(&#34;/login&#34;, methods = [&#39;POST&#39;])
def api_login():
    &#34;&#34;&#34;
    Checks an user&#39;s password and creates his session.
    Required html form parameters: username, password
    &#34;&#34;&#34;
    collection = db.mongo[g.DATABASE_NAME][&#34;Users&#34;]
    user = DAOUser.getUserByUsername(request.form[&#34;username&#34;])
    if user:
        if user.password == hashlib.sha256(request.form[&#34;password&#34;].encode(&#34;utf-8&#34;) + user.salt).digest():
            session[&#34;user&#34;] = user.username
            session[&#34;is_admin&#34;] = user.is_admin
            session.permanent = True
            return redirect(&#34;/&#34;)
        else:
            return Response(&#34;Invalid password for user {0}&#34;.format(user.username), status=401)
    return Response(&#34;The user {0} doesn&#39;t exist&#34;.format(request.form[&#34;username&#34;]), status=401)

#Logout
bp_api_logout = Blueprint(&#34;api_logout&#34;, __name__, url_prefix=&#34;/api&#34;)

@bp_api_logout.route(&#34;/logout&#34;, methods = [&#39;GET&#39;])
def api_logout():
    &#34;&#34;&#34;
    Clears an user&#39;s session.
    &#34;&#34;&#34;
    if &#34;user&#34; in session.keys():
        session.clear()
        return redirect(&#34;/&#34;)
    else:
        return &#34;You are not logged in&#34;</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="Toto.api.routes.api_login"><code class="name flex">
<span>def <span class="ident">api_login</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Checks an user's password and creates his session.
Required html form parameters: username, password</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@bp_api_login.route(&#34;/login&#34;, methods = [&#39;POST&#39;])
def api_login():
    &#34;&#34;&#34;
    Checks an user&#39;s password and creates his session.
    Required html form parameters: username, password
    &#34;&#34;&#34;
    collection = db.mongo[g.DATABASE_NAME][&#34;Users&#34;]
    user = DAOUser.getUserByUsername(request.form[&#34;username&#34;])
    if user:
        if user.password == hashlib.sha256(request.form[&#34;password&#34;].encode(&#34;utf-8&#34;) + user.salt).digest():
            session[&#34;user&#34;] = user.username
            session[&#34;is_admin&#34;] = user.is_admin
            session.permanent = True
            return redirect(&#34;/&#34;)
        else:
            return Response(&#34;Invalid password for user {0}&#34;.format(user.username), status=401)
    return Response(&#34;The user {0} doesn&#39;t exist&#34;.format(request.form[&#34;username&#34;]), status=401)</code></pre>
</details>
</dd>
<dt id="Toto.api.routes.api_logout"><code class="name flex">
<span>def <span class="ident">api_logout</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Clears an user's session.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@bp_api_logout.route(&#34;/logout&#34;, methods = [&#39;GET&#39;])
def api_logout():
    &#34;&#34;&#34;
    Clears an user&#39;s session.
    &#34;&#34;&#34;
    if &#34;user&#34; in session.keys():
        session.clear()
        return redirect(&#34;/&#34;)
    else:
        return &#34;You are not logged in&#34;</code></pre>
</details>
</dd>
<dt id="Toto.api.routes.create_board"><code class="name flex">
<span>def <span class="ident">create_board</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Creates a new board.
Required html form parameters: board_name, abbreviation.
WARNING: Requires admin permissions.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@bp_create_board.route(&#34;/create_board&#34;, methods = [&#39;POST&#39;])
def create_board():
    &#34;&#34;&#34;
    Creates a new board.
    Required html form parameters: board_name, abbreviation.
    WARNING: Requires admin permissions.
    &#34;&#34;&#34;
    if session[&#39;is_admin&#39;]:
        data = request.form
        try:
            db.mongo[g.DATABASE_NAME].create_collection(name=&#34;Board_{0}&#34;.format(data[&#34;board_name&#34;].capitalize()), check_exists=True)
            collection_boards = db.mongo[g.DATABASE_NAME][&#34;Boards&#34;]
            board_data = {&#34;collection_name&#34;: &#34;Board_{0}&#34;.format(data[&#34;board_name&#34;].capitalize()), &#34;name&#34;: data[&#34;board_name&#34;].capitalize(), &#34;abbreviation&#34;: data[&#34;abbreviation&#34;].lower()}
            collection_boards.insert_one(board_data)
            collection_counters = db.mongo[g.DATABASE_NAME][&#34;Counters&#34;]
            counter_data = {&#34;collection&#34;: &#34;Board_{0}&#34;.format(data[&#34;board_name&#34;].capitalize()), &#34;sequence&#34;: 0}
            collection_counters.insert_one(counter_data)
            return redirect(&#34;/{0}/&#34;.format(board_data[&#34;abbreviation&#34;]))
        except CollectionInvalid:
            return Response(&#34;A board with this name already exists&#34;, status=409)
    else:
        return Response(&#34;You don&#39;t have permissions to delete create boards&#34;, status=403)</code></pre>
</details>
</dd>
<dt id="Toto.api.routes.create_comment"><code class="name flex">
<span>def <span class="ident">create_comment</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Creates a comment under the the desired post.
Required url args: 'board' (name of the collection).
Required html form parameters: id (this is the id of the post we want to comment under), response_to, username, content and a file named 'media'.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@bp_create_comment.route(&#34;/create_comment&#34;, methods = [&#39;POST&#39;])
def create_comment():
    &#34;&#34;&#34;
    Creates a comment under the the desired post.
    Required url args: &#39;board&#39; (name of the collection).
    Required html form parameters: id (this is the id of the post we want to comment under), response_to, username, content and a file named &#39;media&#39;.
    &#34;&#34;&#34;
    board = request.args.get(&#34;board&#34;)
    data = request.form
    media = request.files[&#34;media&#34;]
    media_fileformat = media.filename.split(&#34;.&#34;)[-1]
    path = None
    generated_filename = None
    if media:
        generated_filename = &#34;{0}.{1}&#34;.format(str(random.randint(10_000_000, 99_999_999)), media_fileformat)
        if media_fileformat in g.ALLOWED_IMAGE_EXTENSIONS:
            path = os.path.normpath(os.path.join(os.path.dirname(__file__), &#34;../site/templates/static/images/&#34;, generated_filename))
        elif media_fileformat in g.ALLOWED_VIDEO_EXTENSIONS:
            path = os.path.normpath(os.path.join(os.path.dirname(__file__), &#34;../site/templates/static/videos/&#34;, generated_filename))
        else:
            return Response(&#34;Invalid file format&#34;, status=415)
        media.save(path)
    post = DAOPosts.getPostByIdOrCommentId(data[&#34;id&#34;], board)
    if post:
        comment = {&#34;_id&#34;: DAOCounter.getBoardSequence(board), &#34;response_to&#34;: data[&#34;response_to&#34;], &#34;username&#34;: data[&#34;username&#34;], &#34;filename&#34;: generated_filename, &#34;date&#34;: datetime.now(), &#34;content&#34;: data[&#34;content&#34;]}
        collection = db.mongo[g.DATABASE_NAME][board]
        collection.update_one({&#34;_id&#34;: post.id}, {&#34;$push&#34;: {&#34;comments&#34;: comment}})
        logger.info(&#34;New comment with id {0} created on {1} by {2}&#34;.format(comment[&#34;_id&#34;], board, comment[&#34;username&#34;]))
        return redirect(&#34;/{0}/{1}&#34;.format(DAOBoard.getBoardByCollectionName(board).abbreviation, post.id))
    else:
        return Response(&#34;There is no post that has or contains this id&#34;, status=404)</code></pre>
</details>
</dd>
<dt id="Toto.api.routes.create_post"><code class="name flex">
<span>def <span class="ident">create_post</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Creates a post in the desired board.
Required url args: 'board' (name of the collection).
Required html form parameters: username, title, content and a file named 'media'.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@bp_create_post.route(&#34;/create_post&#34;, methods = [&#39;POST&#39;])
def create_post():
    &#34;&#34;&#34;
    Creates a post in the desired board.
    Required url args: &#39;board&#39; (name of the collection).
    Required html form parameters: username, title, content and a file named &#39;media&#39;.
    &#34;&#34;&#34;
    board = request.args.get(&#39;board&#39;)
    if DAOBoard.checkIfBoardExists(board):
        board = DAOBoard.getBoardByCollectionName(board)
        collection = db.mongo[g.DATABASE_NAME][board.collection_name]
        data = request.form
        media = request.files[&#34;media&#34;]
        media_fileformat = media.filename.split(&#34;.&#34;)[-1]
        generated_filename = None
        path = None
        if media:
            generated_filename = &#34;{0}.{1}&#34;.format(str(random.randint(10_000_000, 99_999_999)), media_fileformat)
            if media_fileformat in g.ALLOWED_IMAGE_EXTENSIONS:
                path = os.path.normpath(os.path.join(os.path.dirname(__file__), &#34;../site/templates/static/images/&#34;, generated_filename))
            elif media_fileformat in g.ALLOWED_VIDEO_EXTENSIONS:
                path = os.path.join(os.path.normpath(os.path.join(os.path.dirname(__file__), &#34;../site/templates/static/videos/&#34;, generated_filename)))
            else:
                return Response(&#34;Invalid file format&#34;, status=415)
            media.save(path)
        post = Post(DAOCounter.getBoardSequence(board.collection_name), False, data[&#34;title&#34;], data[&#34;username&#34;], datetime.now(), generated_filename, data[&#34;content&#34;], [])
        collection.insert_one(post.to_dict())
        logger.info(&#34;New post created on {0} with id {1} by {2}&#34;.format(board.collection_name, post.id, post.username))
        DAOPosts.deleteLastPostIfOverLimit(board.collection_name)
        return redirect(&#34;/{0}/&#34;.format(board.abbreviation))
    else:
        return Response(&#34;Board {0} not found&#34;.format(board.collection_name), status=404)</code></pre>
</details>
</dd>
<dt id="Toto.api.routes.create_user"><code class="name flex">
<span>def <span class="ident">create_user</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Creates a new user.
Required html form parameters: username, email, password.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@bp_create_user.route(&#34;/create_user&#34;, methods = [&#39;POST&#39;])
def create_user():
    &#34;&#34;&#34;
    Creates a new user.
    Required html form parameters: username, email, password.
    &#34;&#34;&#34;
    collection = db.mongo[g.DATABASE_NAME][&#34;Users&#34;]
    if len(request.form[&#34;password&#34;]) &lt; 8:
        return Response(&#34;Invalid password length, the password must be at least 8 characters long&#34;, status=400)
    try:
        salt = os.urandom(16)
        user = User(request.form[&#34;username&#34;], request.form[&#34;email&#34;], hashlib.sha256(request.form[&#34;password&#34;].encode(&#34;utf-8&#34;) + salt).digest(), salt, False, datetime.now())
        collection.insert_one(user.to_dict())
        logger.info(&#34;New user {0} created&#34;.format(user.username))
        flash(&#34;User created successfully&#34;)
        return redirect(&#34;/user/login&#34;)
    except DuplicateKeyError:
        return Response(&#34;Username {0} already exists&#34;.format(user.username), status=400)</code></pre>
</details>
</dd>
<dt id="Toto.api.routes.delete_comment"><code class="name flex">
<span>def <span class="ident">delete_comment</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Deletes a comment by it's id and the parent's post id
Required url args: 'board' (name of the collection), 'comment_id', 'post_id'.
WARNING: Requires admin permissions.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@bp_delete_comment.route(&#34;/delete_comment&#34;, methods = [&#39;GET&#39;])
def delete_comment():
    &#34;&#34;&#34;
    Deletes a comment by it&#39;s id and the parent&#39;s post id
    Required url args: &#39;board&#39; (name of the collection), &#39;comment_id&#39;, &#39;post_id&#39;.
    WARNING: Requires admin permissions.
    &#34;&#34;&#34;
    board = request.args.get(&#34;board&#34;)
    board = DAOBoard.getBoardByCollectionName(board)
    post_id = request.args.get(&#34;post_id&#34;)
    comment_id = request.args.get(&#34;comment_id&#34;)
    if session[&#39;is_admin&#39;]:
        if DAOBoard.checkIfBoardExists(board.collection_name):
            if DAOPosts.deleteCommentById(comment_id, post_id, board.collection_name):
                logger.info(&#34;Deleted comment with id {0} on post {1} in {2}&#34;.format(comment_id, post_id, board.collection_name))
                return redirect(&#34;/{0}/{1}&#34;.format(board.abbreviation, post_id))
            else:
                return Response(&#34;Couldn&#39;t delete the comment {0}&#34;.format(post_id), status=404)
        else:
            return Response(&#34;Board {0} not found&#34;.format(board.collection_name), status=404)
    else:
        return Response(&#34;You don&#39;t enough permissions to delete comments&#34;, status=403)</code></pre>
</details>
</dd>
<dt id="Toto.api.routes.delete_post"><code class="name flex">
<span>def <span class="ident">delete_post</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Deletes a post by it's id from the specified board.
Required url args: 'board' (name of the collection), 'post_id'.
WARNING: Requires admin permissions.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@bp_delete_post.route(&#34;/delete_post&#34;, methods = [&#39;GET&#39;])
def delete_post():
    &#34;&#34;&#34;
    Deletes a post by it&#39;s id from the specified board.
    Required url args: &#39;board&#39; (name of the collection), &#39;post_id&#39;.
    WARNING: Requires admin permissions.
    &#34;&#34;&#34;
    board = request.args.get(&#34;board&#34;)
    board = DAOBoard.getBoardByCollectionName(board)
    post_id = request.args.get(&#34;post_id&#34;)
    if session[&#39;is_admin&#39;]:
        if DAOBoard.checkIfBoardExists(board.collection_name):
            if DAOPosts.deletePostById(post_id, board.collection_name):
                logger.info(&#34;Deleted post with id {0} in {1}&#34;.format(post_id, board.collection_name))
                return redirect(&#34;/{0}/&#34;.format(board.abbreviation))
            else:
                return Response(&#34;Couldn&#39;t delete the post {0}&#34;.format(post_id), status=404)
        else:
            return Response(&#34;Board {0} not found&#34;.format(board.collection_name), status=404)
    else:
        return Response(&#34;You don&#39;t enough permissions to delete posts&#34;, status=403)</code></pre>
</details>
</dd>
<dt id="Toto.api.routes.get_boards"><code class="name flex">
<span>def <span class="ident">get_boards</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Returns a json with all the boards.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@bp_get_boards.route(&#34;/get_boards&#34;, methods = [&#39;GET&#39;])
def get_boards():
    &#34;&#34;&#34;
    Returns a json with all the boards.
    &#34;&#34;&#34;
    return jsonify(DAOBoard.getAllBoards())</code></pre>
</details>
</dd>
<dt id="Toto.api.routes.get_posts"><code class="name flex">
<span>def <span class="ident">get_posts</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Returns a json with all the posts from a board.
Required url args: 'board' (name of the collection).</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">@bp_get_posts.route(&#34;/get_posts&#34;, methods = [&#39;GET&#39;])
def get_posts():
    &#34;&#34;&#34;
    Returns a json with all the posts from a board.
    Required url args: &#39;board&#39; (name of the collection).
    &#34;&#34;&#34;
    board = request.args.get(&#39;board&#39;)
    if DAOBoard.checkIfBoardExists(board):
        return jsonify(DAOPosts.getAllPostsFromBoard(board))
    else:
        return Response(&#34;Board {0} not found&#34;.format(board), status=404)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="Toto.api" href="index.html">Toto.api</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="two-column">
<li><code><a title="Toto.api.routes.api_login" href="#Toto.api.routes.api_login">api_login</a></code></li>
<li><code><a title="Toto.api.routes.api_logout" href="#Toto.api.routes.api_logout">api_logout</a></code></li>
<li><code><a title="Toto.api.routes.create_board" href="#Toto.api.routes.create_board">create_board</a></code></li>
<li><code><a title="Toto.api.routes.create_comment" href="#Toto.api.routes.create_comment">create_comment</a></code></li>
<li><code><a title="Toto.api.routes.create_post" href="#Toto.api.routes.create_post">create_post</a></code></li>
<li><code><a title="Toto.api.routes.create_user" href="#Toto.api.routes.create_user">create_user</a></code></li>
<li><code><a title="Toto.api.routes.delete_comment" href="#Toto.api.routes.delete_comment">delete_comment</a></code></li>
<li><code><a title="Toto.api.routes.delete_post" href="#Toto.api.routes.delete_post">delete_post</a></code></li>
<li><code><a title="Toto.api.routes.get_boards" href="#Toto.api.routes.get_boards">get_boards</a></code></li>
<li><code><a title="Toto.api.routes.get_posts" href="#Toto.api.routes.get_posts">get_posts</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>